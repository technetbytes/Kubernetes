# File: .github/workflows/cd-pipeline.yml

name: CD Pipeline on Self-Hosted Runner

on:
  push:
    branches:
      - main  # or your deployment branch
    paths:
      - 'CD-Pipeline-Github-Actions/**'  # only run when this directory is changed

jobs:
  deploy-to-dev:
    runs-on: self-hosted
    container:
      image: ubuntu:22.04
    steps:
    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y wget
        wget -qO "/usr/local/bin/kubectl" https://dl.k8s.io/release/v1.27.3/bin/linux/amd64/kubectl
        chmod +x "/usr/local/bin/kubectl"
        kubectl config set-cluster kind-actions-kind --server=https://host.docker.internal:6444/ --insecure-skip-tls-verify=true
        kubectl config set-credentials actions-dev --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IkZaYjJXbFgwRndGSzBEa2dVc2dQeUlrNWtsMEI4QWlxTUhoakp4ZGZibjgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzUyNjcyMDg4LCJpYXQiOjE3NTI2Njg0ODgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiZjQzZjVkZmQtNmZmZC00NGFjLWJhOTktYzgzNGY3MzBlMWY5Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZXYiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiYWN0aW9ucy1kZXYiLCJ1aWQiOiI5NjY4ZDRmOC02MGIyLTRlN2QtODBhYS0zOWNhOTA0Y2Q4NWIifX0sIm5iZiI6MTc1MjY2ODQ4OCwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRldjphY3Rpb25zLWRldiJ9.nicv2Lbb86Phlj-yqY99ds6nP7KRqdym8ctZd7UDfr-YrbIYRFlXiQSWQkmeT8kPV44NeOdFVIQtUUmFpaW4dwwtjhFfkZGBkZkuWCoRgpIzqRg1ZVKk1KmWIKqMpJfDrlcQ_RYzYAPbVGracSFei7DQaThvAL3bWUm-tyyw8DlIC-faeuUiwasf8AaQbYej3N3vbcaSjHpR9maPrGDRsvcr5ElCJXSKq6KjTLnWPn69-CaWjpuCq_NznVbPBkAPcPq3wvMuEQ_wjENMgQLvHFqMcpIx87ZsoJeCQK6YSmDnVeCZ4_Bc5RPWmYpUlHSpxEu_FXVvY9EbNbhUD7CBgQ"
        kubectl config set-context actions-dev --user=actions-dev --cluster=kind-actions-kind --namespace=dev
        kubectl config use-context actions-dev
    - name: Deploy to dev namespace
      run: |
        kubectl create deploy flask-ping-server --image=\${{ secrets.DOCKERHUB_USERNAME }}/flask-ping-server:latest --replicas=2 --port=5000 --dry-run=client -o yaml > flask-ping-server.yaml
        kubectl replace --force -f flask-ping-server.yaml
    
